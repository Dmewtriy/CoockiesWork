import telebot
import requests

# ????????? ?????? ?????? ????
TELEGRAM_API_TOKEN = '7763432669:AAFLq98WvZk0RNpZXgJmlO6dyPoL7djRe74'
DOMOFON_API_URL = 'https://domo-dev.profintel.ru/tg-bot/docs'  # ???????? ?? ???????? URL API ????????

# ????????????? ????
bot = telebot.TeleBot(TELEGRAM_API_TOKEN)


# ??????? /start
@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id,
                     '????? ??????????! ??????????, ????????????? ? ??????? ??????? /login <?????_????????>.')


# ??????? ??? ??????????? ????????????
@bot.message_handler(commands=['login'])
def login(message):
    phone_number = message.text.split()[1] if len(message.text.split()) > 1 else None

    if not phone_number:
        bot.send_message(message.chat.id, '???????????: /login <?????_????????>')
        return

    response = requests.post(f'{DOMOFON_API_URL}/auth', json={'phone': phone_number})

    if response.status_code == 200:
        bot.send_message(message.chat.id, '?? ??????? ????????????!')
        bot.send_message(message.chat.id, f'??? ????? ????????: {phone_number}')
        # ????????? ????? ???????? ? user_data (????? ???????????? ????????? ??????)
        # ? ?????? ??????? ?????? ????????? ? ???????? ??????? ?????????
        message.from_user.phone = phone_number
    else:
        error_message = response.json().get('error', '?????? ???????????.')
        bot.send_message(message.chat.id, error_message)


# ??????? ??? ????????? ?????? ?????????
@bot.message_handler(commands=['list'])
def list_domofons(message):
    phone_number = getattr(message.from_user, 'phone', None)

    if not phone_number:
        bot.send_message(message.chat.id, '??????? ????????????? ? ??????? /login.')
        return

    response = requests.get(f'{DOMOFON_API_URL}/domofons?phone={phone_number}')

    if response.status_code == 200:
        domofons = response.json()
        if domofons:
            message_text = "?????? ????????? ?????????:\n"
            for domofon in domofons:
                message_text += f"{domofon['id']}: {domofon['name']}\n"
            bot.send_message(message.chat.id, message_text)
        else:
            bot.send_message(message.chat.id, '??? ????????? ?????????.')
    else:
        error_message = response.json().get('error', '?????? ????????? ?????? ?????????.')
        bot.send_message(message.chat.id, error_message)


# ??????? ??? ????????? ?????? ? ?????? ????????
@bot.message_handler(commands=['snapshot'])
def get_camera_snapshot(message):
    phone_number = getattr(message.from_user, 'phone', None)

    if not phone_number:
        bot.send_message(message.chat.id, '??????? ????????????? ? ??????? /login.')
        return

    domofon_id = message.text.split()[1] if len(message.text.split()) > 1 else None

    if not domofon_id:
        bot.send_message(message.chat.id, '???????????: /snapshot <id_????????>')
        return

    response = requests.get(f'{DOMOFON_API_URL}/domofons/{domofon_id}/snapshot?phone={phone_number}')

    if response.status_code == 200:
        snapshot_url = response.json().get('snapshot_url')
        bot.send_photo(message.chat.id, photo=snapshot_url)
    else:
        error_message = response.json().get('error', '?????? ????????? ??????.')
        bot.send_message(message.chat.id, error_message)


# ??????? ??? ???????? ????????
@bot.message_handler(commands=['open'])
def open_domofon(message):
    phone_number = getattr(message.from_user, 'phone', None)

    if not phone_number:
        bot.send_message(message.chat.id, '??????? ????????????? ? ??????? /login.')
        return

    domofon_id = message.text.split()[1] if len(message.text.split()) > 1 else None

    if not domofon_id:
        bot.send_message(message.chat.id, '???????????: /open <id_????????>')
        return

    response = requests.post(f'{DOMOFON_API_URL}/domofons/{domofon_id}/open', json={'phone': phone_number})

    if response.status_code == 200:
        bot.send_message(message.chat.id, '????? ??????? ???????!')
    else:
        error_message = response.json().get('error', '?????? ??? ???????? ?????.')
        bot.send_message(message.chat.id, error_message)

        # ?????? ????
    if __name__ == '__main__':
        bot.polling(none_stop=True)